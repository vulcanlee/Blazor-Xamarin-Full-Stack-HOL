@using Microsoft.Extensions.Logging
@using Prism.Events
@inject IEventAggregator EventAggregator
@inject ILogger<GlobalEventView> Logger
@inject SystemBroadcast SystemBroadcast
@implements IDisposable

@code {

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {
            await Task.Yield();
            //Logger.LogDebug("GlobalEventView OnAfterRenderAsync");
            SystemBroadcast.Unsubscribe(OnMessageConnection);
            SystemBroadcast.Subscribe(OnMessageConnection);
            SystemBroadcast.UnsubscribeConcurrentConnection(OnConnection);
            SystemBroadcast.SubscribeConcurrentConnection(OnConnection);
            SystemBroadcast.PublishConcurrentConnection();

            EventAggregator.GetEvent<BroadcastEvent>().Subscribe(x =>
            {
                SystemBroadcast.Publish(x.Content);
            });
        }
    }

    public void OnConnection(int foo)
    {
        EventAggregator.GetEvent<ToastEvent>().Publish(new ToastPayload()
        {
            Title = "通知",
            Content = $"使用者連線數量 {foo}",
            Timeout = 4000,
            Color = "Green",
        });
    }
    public void OnMessageConnection(string foo)
    {
        EventAggregator.GetEvent<ToastEvent>().Publish(new ToastPayload()
        {
            Title = "通知",
            Content = $"{foo}",
            Timeout = 4000,
        });
    }
    public void Dispose()
    {
        SystemBroadcast.Unsubscribe(OnMessageConnection);
        SystemBroadcast.Unsubscribe(OnMessageConnection);
        SystemBroadcast.UnsubscribeConcurrentConnection(OnConnection);
        SystemBroadcast.UnsubscribeConcurrentConnection(OnConnection);
        SystemBroadcast.PublishConcurrentConnection();
        //Logger.LogDebug("GlobalEventView Dispose");
    }
}
